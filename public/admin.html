<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin – AutoVINReveal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; --b:#e5e7eb; --muted:#64748b; --brand:#1d4ed8 }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif; margin:0; padding:24px; }
    .card { border:1px solid var(--b); border-radius:14px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.06) }
    h1 { margin:0 0 10px 0; }
    input[type=password], input[type=text] { width: 260px; padding:8px 10px; border:1px solid var(--b); border-radius:10px; }
    button { padding:8px 12px; border-radius:10px; border:1px solid var(--b); background:#fff; cursor:pointer }
    button.primary { background: var(--brand); color:#fff; border-color: color-mix(in srgb, var(--brand) 60%, #fff) }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .tabs { display:flex; gap:8px; margin-top:12px }
    .tab { padding:8px 10px; border-radius:999px; border:1px solid var(--b); cursor:pointer }
    .tab.active { background: var(--brand); color:#fff }
    table { width:100%; border-collapse: collapse; margin-top:12px; font-size:14px }
    th, td { padding:8px 10px; border-bottom:1px solid var(--b) }
    .muted{ color:var(--muted) }
    .pad { padding:12px 0 }
    .right { text-align: right }
    .hidden { display:none }
    .pill { font-size:12px; border:1px solid var(--b); padding:2px 8px; border-radius:999px; color:var(--muted) }
    .grow { flex:1 }
  </style>
</head>
<body>
  <div class="card">
    <div class="row">
      <h1>Admin</h1>
      <span id="statusPill" class="pill">signed out</span>
      <span class="grow"></span>
      <button id="logoutBtn" class="hidden">Log out</button>
    </div>

    <!-- Sign-in -->
    <div id="loginBox" class="pad">
      <div class="row">
        <input id="pwd" type="password" placeholder="Admin password" />
        <button id="loginBtn" class="primary">Sign in</button>
      </div>
      <p class="muted" style="margin-top:8px">Password is checked server-side. Cookie is httpOnly &amp; short-lived.</p>
    </div>

    <!-- Tabs -->
    <div id="tabs" class="tabs hidden">
      <div class="tab active" data-tab="cache">Cache</div>
      <div class="tab" data-tab="history">History</div>
    </div>

    <!-- Cache -->
    <div id="view-cache" class="pad hidden">
      <div class="row">
        <input id="vinInput" type="text" placeholder="VIN (optional for quick open)" />
        <select id="typeInput">
          <option value="carfax">carfax</option>
          <option value="autocheck">autocheck</option>
        </select>
        <button id="openHtmlBtn">Open HTML</button>
        <button id="downloadPdfBtn">Download PDF</button>
        <button id="fetchLiveBtn" class="primary">Fetch live (no cost)</button>
      </div>

      <table id="cacheTable">
        <thead>
          <tr>
            <th>VIN</th><th>Type</th><th class="right">Size</th><th>Updated</th><th>Action</th>
          </tr>
        </thead>
        <tbody id="cacheBody"></tbody>
      </table>
    </div>

    <!-- History -->
    <div id="view-history" class="pad hidden">
      <table>
        <thead>
          <tr>
            <th>ID</th><th>VIN</th><th>Success</th><th>User</th><th>Time</th>
          </tr>
        </thead>
        <tbody id="histBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const statusPill = $('statusPill');
    const loginBox = $('loginBox');
    const tabs = $('tabs');
    const logoutBtn = $('logoutBtn');

    function toast(msg){ alert(msg); }

    async function who() {
      try {
        const r = await fetch('/api/admin/whoami');
        const j = await r.json();
        return !!j.admin;
      } catch { return false; }
    }
    function showSignedInUI() {
      statusPill.textContent = 'signed in';
      loginBox.classList.add('hidden');
      tabs.classList.remove('hidden');
      logoutBtn.classList.remove('hidden');
      activateTab('cache');
      loadCache();
    }
    function showSignedOutUI() {
      statusPill.textContent = 'signed out';
      loginBox.classList.remove('hidden');
      tabs.classList.add('hidden');
      logoutBtn.classList.add('hidden');
      $('view-cache').classList.add('hidden');
      $('view-history').classList.add('hidden');
    }

    $('loginBtn').addEventListener('click', async ()=>{
      const password = $('pwd').value.trim();
      if (!password) return toast('Enter password');
      const r = await fetch('/api/admin/login', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ password })
      });
      if (r.ok) showSignedInUI();
      else toast('Wrong password');
    });

    logoutBtn.addEventListener('click', async ()=>{
      await fetch('/api/admin/logout',{method:'POST'});
      showSignedOutUI();
    });

    // Tabs
    function activateTab(name){
      document.querySelectorAll('.tab').forEach(t=>{
        t.classList.toggle('active', t.dataset.tab===name);
      });
      $('view-cache').classList.toggle('hidden', name!=='cache');
      $('view-history').classList.toggle('hidden', name!=='history');
      if (name==='cache') loadCache();
      if (name==='history') loadHistory();
    }
    document.querySelectorAll('.tab').forEach(t=>{
      t.addEventListener('click', ()=>activateTab(t.dataset.tab));
    });

    // Cache data
    async function loadCache(){
      const body = $('cacheBody');
      body.innerHTML = '<tr><td colspan="5" class="muted">Loading…</td></tr>';
      try {
        const r = await fetch('/api/admin/cache');
        if (!r.ok) throw new Error('not ok');
        const { rows=[] } = await r.json();
        if (!rows.length) { body.innerHTML = '<tr><td colspan="5" class="muted">Empty.</td></tr>'; return; }
        body.innerHTML = '';
        for (const row of rows) {
          const tr = document.createElement('tr');
          const dt = new Date(row.mtime);
          const kb = Math.round(row.size/1024);
          tr.innerHTML = `
            <td style="font-family:ui-monospace,Menlo,Consolas">${row.vin}</td>
            <td>${row.type}</td>
            <td class="right">${kb.toLocaleString()} KB</td>
            <td>${dt.toLocaleString()}</td>
            <td>
              <button data-act="open" data-vin="${row.vin}" data-type="${row.type}">Open</button>
              <button data-act="pdf"  data-vin="${row.vin}" data-type="${row.type}">PDF</button>
              <button data-act="fetch" data-vin="${row.vin}" data-type="${row.type}">Fetch live</button>
            </td>
          `;
          body.appendChild(tr);
        }
        body.querySelectorAll('button').forEach(btn=>{
          btn.addEventListener('click', handleRowAction);
        });
      } catch {
        body.innerHTML = '<tr><td colspan="5" class="muted">Failed.</td></tr>';
      }
    }

    async function handleRowAction(e){
      const b = e.currentTarget;
      const act = b.dataset.act;
      const vin = b.dataset.vin;
      const type = b.dataset.type || 'carfax';
      if (act==='open') window.open(`/api/admin/open?vin=${encodeURIComponent(vin)}&type=${encodeURIComponent(type)}&as=html`, '_blank');
      if (act==='pdf')  window.location = `/api/admin/open?vin=${encodeURIComponent(vin)}&type=${encodeURIComponent(type)}&as=pdf`;
      if (act==='fetch') {
        b.disabled = true; b.textContent = 'Fetching…';
        try {
          const r = await fetch(`/api/admin/open?vin=${encodeURIComponent(vin)}&type=${encodeURIComponent(type)}&fetch=1`);
          if (!r.ok) throw 0;
          toast('Fetched & cached.');
          loadCache();
        } catch { toast('Fetch failed'); }
        finally { b.disabled = false; b.textContent = 'Fetch live'; }
      }
    }

    // Quick controls
    $('openHtmlBtn').addEventListener('click', ()=>{
      const vin = $('vinInput').value.trim().toUpperCase();
      const type = $('typeInput').value;
      if (!vin) return toast('Enter VIN');
      window.open(`/api/admin/open?vin=${encodeURIComponent(vin)}&type=${encodeURIComponent(type)}&as=html`, '_blank');
    });
    $('downloadPdfBtn').addEventListener('click', ()=>{
      const vin = $('vinInput').value.trim().toUpperCase();
      const type = $('typeInput').value;
      if (!vin) return toast('Enter VIN');
      window.location = `/api/admin/open?vin=${encodeURIComponent(vin)}&type=${encodeURIComponent(type)}&as=pdf`;
    });
    $('fetchLiveBtn').addEventListener('click', async ()=>{
      const vin = $('vinInput').value.trim().toUpperCase();
      const type = $('typeInput').value;
      if (!vin) return toast('Enter VIN');
      try {
        const r = await fetch(`/api/admin/open?vin=${encodeURIComponent(vin)}&type=${encodeURIComponent(type)}&fetch=1`);
        if (!r.ok) throw 0;
        toast('Fetched & cached.');
        loadCache();
      } catch { toast('Fetch failed'); }
    });

    // History
    async function loadHistory(){
      const body = $('histBody');
      body.innerHTML = '<tr><td colspan="5" class="muted">Loading…</td></tr>';
      try {
        const r = await fetch('/api/admin/history?limit=200');
        if (!r.ok) throw 0;
        const { rows=[] } = await r.json();
        if (!rows.length) { body.innerHTML = '<tr><td colspan="5" class="muted">No entries.</td></tr>'; return; }
        body.innerHTML = '';
        for (const row of rows) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.id}</td>
            <td style="font-family:ui-monospace,Menlo,Consolas">${row.vin}</td>
            <td>${row.success ? '✅' : '❌'}</td>
            <td class="muted">${row.user_id || ''}</td>
            <td>${new Date(row.created_at).toLocaleString()}</td>
          `;
          body.appendChild(tr);
        }
      } catch {
        body.innerHTML = '<tr><td colspan="5" class="muted">Failed.</td></tr>';
      }
    }

    // boot
    (async ()=>{
      if (await who()) showSignedInUI();
      else showSignedOutUI();
    })();
  </script>
</body>
</html>
